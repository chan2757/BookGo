<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookgo.mapper.PaymentViewMapper">

    <!-- PaymentViewVO에 대한 resultMap 정의 -->
    <resultMap id="PaymentViewResultMap" type="com.bookgo.vo.PaymentViewVO">
        <id property="requestId" column="REQUEST_ID" />
        <result property="totalAmount" column="TOTAL_AMOUNT" />
        <result property="createdAt" column="CREATED_AT" />
        <result property="fullName" column="FULL_NAME" />
        <result property="email" column="EMAIL" />
        <result property="phone" column="PHONE" />
        <result property="address" column="ADDRESS" />
        <collection property="products" ofType="com.bookgo.vo.PaymentProductVO" resultMap="PaymentProductResultMap" />
    </resultMap>

    <!-- PaymentProductVO에 대한 resultMap 정의 -->
    <resultMap id="PaymentProductResultMap" type="com.bookgo.vo.PaymentProductVO">
        <id property="productName" column="PRODUCT_NAME" />
        <result property="isbn13" column="ISBN13" />
        <result property="quantity" column="QUANTITY" />
        <result property="itemPrice" column="ITEM_PRICE" />
        <result property="totalPrice" column="TOTAL_PRICE" />
        <result property="createdAt" column="CREATED_AT" />
    </resultMap>

    <!-- 결제 요청 리스트 조회 -->
    <select id="selectPaymentRequestsByUsername" parameterType="String" resultMap="PaymentViewResultMap">
        SELECT
            r.REQUEST_ID,
            r.TOTAL_AMOUNT,
            r.CREATED_AT,
            r.FULL_NAME,
            r.EMAIL,
            r.PHONE,
            r.ADDRESS,
            d.PRODUCT_NAME,
            d.ISBN13,
            d.QUANTITY,
            d.ITEM_PRICE,
            d.TOTAL_PRICE,
            d.CREATED_AT AS PRODUCT_CREATED_AT
        FROM
            PAYMENT_REQUEST r
                LEFT JOIN
            PAYMENT_DETAIL d ON r.ORDER_ID = d.REQUEST_ID
        WHERE
            r.USERNAME = #{username}
        ORDER BY
            r.CREATED_AT DESC
    </select>

    <select id="selectPaymentRequests" parameterType="String" resultMap="PaymentViewResultMap">
        SELECT
            r.REQUEST_ID,
            r.TOTAL_AMOUNT,
            r.CREATED_AT,
            r.FULL_NAME,
            r.EMAIL,
            r.PHONE,
            r.ADDRESS,
            d.PRODUCT_NAME,
            d.ISBN13,
            d.QUANTITY,
            d.ITEM_PRICE,
            d.TOTAL_PRICE,
            d.CREATED_AT AS PRODUCT_CREATED_AT
        FROM
            PAYMENT_REQUEST r
                LEFT JOIN
            PAYMENT_DETAIL d ON r.ORDER_ID = d.REQUEST_ID

        ORDER BY
            r.CREATED_AT DESC
    </select>
</mapper>
