<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²Œì‹œê¸€ ìƒì„¸</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <style>
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .post-info {
      margin-left: 10px;
      color: #6c757d;
    }
    .post-content {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .post-footer {
      display: flex;
      justify-content: space-between;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 20px;
    }
    .btn-back {
      margin-top: 20px;
    }
    .post-image {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 10px;
    }
    .comment-section {
      margin-top: 30px;
    }
    .comment-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .comment-actions {
      display: flex;
      gap: 10px;
    }
    .comment-content {
      flex: 1;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- ê²Œì‹œê¸€ ì œëª© ë° ì‘ì„±ì ì •ë³´ -->
  <div class="card mt-4">
    <div class="card-body">
      <div class="post-header">
        <!-- ì œëª© í‘œì‹œ ë¶€ë¶„ -->
        <h5 class="card-title" id="post-title" th:text="${post.title}">ì œëª©ì´ í‘œì‹œë  ìë¦¬</h5>
        <input type="text" id="edit-title" class="form-control" style="display: none;" th:value="${post.title}">

        <input type="hidden" id="post-id" th:value="${post.postId}">

        <div class="post-info">
          <span th:text="${post.username}">ì‘ì„±ì</span>
          <span class="ml-3" th:text="'ì¡°íšŒìˆ˜: ' + ${post.viewCount}">ì¡°íšŒìˆ˜</span>
          <span class="ml-3" th:text="'ì¶”ì²œìˆ˜: ' + ${post.recommendCount}" id="recommendCount">ì¶”ì²œìˆ˜</span>
        </div>
      </div>

      <!-- ê²Œì‹œê¸€ ë³¸ë¬¸ ë‚´ìš© -->
      <div class="post-content">
        <p id="post-content" th:text="${post.content}">ë‚´ìš©ì´ í‘œì‹œë  ìë¦¬</p>
        <textarea id="edit-content" class="form-control" style="display: none;" th:text="${post.content}"></textarea>
      </div>

      <!-- ê²Œì‹œê¸€ ì‘ì„±ì¼ -->
      <div class="post-footer">
        <button id="recommend-btn" class="btn btn-success">ğŸ‘ ì¶”ì²œí•˜ê¸°</button>
        <small class="text-muted" th:text="'ì‘ì„±ì¼: ' + ${post.createdDate}">ì‘ì„±ì¼</small>
      </div>

      <!-- ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ìì™€ í˜„ì¬ ì‚¬ìš©ìê°€ ê°™ì€ ê²½ìš°ë§Œ í‘œì‹œ) -->
      <div th:if="${currentUsername == post.username}" class="post-footer">
        <button id="edit-btn" class="btn btn-warning">ìˆ˜ì •í•˜ê¸°</button>
        <button id="save-btn" class="btn btn-primary" style="display: none;">ì €ì¥í•˜ê¸°</button>
        <button id="cancel-btn" class="btn btn-secondary" style="display: none;">ì·¨ì†Œí•˜ê¸°</button>
        <button class="btn btn-danger" onclick="deletePost(); return false;">ì‚­ì œí•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
  <div class="comments-section">
    <h5>ëŒ“ê¸€</h5>
    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <ul class="list-group">
      <li th:each="comment : ${comments}" class="list-group-item d-flex justify-content-between align-items-center">
        <input type="hidden" class="comment-id" th:value="${comment.commentId}"/> <!-- commentId íˆë“  í•„ë“œ -->
        <div class="comment-content">
          <strong th:text="${comment.username}">ì‘ì„±ì</strong>
          <small class="text-muted ml-2" th:text="${comment.createdDate}">ì‘ì„±ì¼</small>
          <p class="comment-text" th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
          <textarea class="form-control edit-comment" style="display: none;">[[${comment.content}]]</textarea>
        </div>
        <div class="comment-actions">
          <button class="btn btn-sm btn-outline-success" onclick="recommendComment(this)">ğŸ‘ ì¶”ì²œ (<span th:text="${comment.recommendCount}">0</span>)</button>
          <div th:if="${currentUsername == comment.username}">
            <button class="btn btn-sm btn-outline-warning" onclick="editComment(this)">ìˆ˜ì •</button>
            <button class="btn btn-sm btn-outline-primary" style="display: none;" onclick="saveComment(this)">ì €ì¥</button>
            <button class="btn btn-sm btn-outline-secondary" style="display: none;" onclick="cancelEdit(this)">ì·¨ì†Œ</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(this)">ì‚­ì œ</button>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <!-- ëŒ“ê¸€ ì…ë ¥ í¼ (ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë§Œ ë³´ì´ë„ë¡) -->
  <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
  <form id="comment-form">
    <input type="hidden" name="postId" th:value="${post.postId}">
    <div class="form-group">
      <textarea class="form-control" name="content" id="new-comment" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" rows="3"></textarea>
    </div>
    <button type="button" class="btn btn-primary" onclick="addComment()">ëŒ“ê¸€ ë“±ë¡</button>
  </form>

  <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
  <div class="btn-back">
    <a href="/boardmain" class="btn btn-primary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#edit-btn').on('click', function() {
      $('#post-title').hide();
      $('#post-content').hide();
      $('#edit-title').show();
      $('#edit-content').show();
      $('#edit-btn').hide();
      $('#save-btn').show();
      $('#cancel-btn').show();
    });

    $('#save-btn').on('click', function() {
      if (!confirm('ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const postId = $('#post-id').val();
      const updatedTitle = $('#edit-title').val();
      const updatedContent = $('#edit-content').val();

      $.ajax({
        url: `/board/update/${postId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          title: updatedTitle,
          content: updatedContent
        }),
        success: function(response) {
          alert('ìˆ˜ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          $('#post-title').text(updatedTitle).show();
          $('#post-content').text(updatedContent).show();
          $('#edit-title').hide();
          $('#edit-content').hide();
          $('#save-btn').hide();
          $('#cancel-btn').hide();
          $('#edit-btn').show();
        },
        error: function() {
          alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });

    $('#cancel-btn').on('click', function() {
      $('#edit-title').hide();
      $('#edit-content').hide();
      $('#post-title').show();
      $('#post-content').show();
      $('#save-btn').hide();
      $('#cancel-btn').hide();
      $('#edit-btn').show();
    });
  });

  function deletePost() {
    const postId = $('#post-id').val();

    if (confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      fetch(`/board/delete/${postId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
              .then(response => {
                if (response.ok) {
                  window.location.href = '/boardmain';
                } else {
                  alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
              })
              .catch(error => {
                console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              });
    }
  }

  function addComment() {
    const postId = $('#post-id').val();
    const content = $('#new-comment').val();

    if (!content.trim()) {
      alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    $.ajax({
      url: `/board/${postId}/comment`,
      method: 'POST',
      contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
      data: { content: content },
      success: function() {
        alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        $('#new-comment').val(''); // ì…ë ¥ì°½ ì´ˆê¸°í™”
        location.reload(); // ë˜ëŠ” ëŒ“ê¸€ ëª©ë¡ë§Œ ê°±ì‹ 
      },
      error: function(jqXHR) {
        // ì„œë²„ë¡œë¶€í„° ë°›ì€ ìƒíƒœ ì½”ë“œì™€ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ê³  ì²˜ë¦¬
        if (jqXHR.status === 401) {
          alert(jqXHR.responseText || 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        } else {
          alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }
    });
  }
  // ëŒ“ê¸€ ì¶”ì²œ í•¨ìˆ˜
  function recommendComment(button) {
    const commentId = $(button).closest('.list-group-item').find('.comment-id').val(); // commentId ê°€ì ¸ì˜¤ê¸°

    // ì¿ í‚¤ì— ì¶”ì²œ ì—¬ë¶€ í™•ì¸
    const cookieName = `recommended_comment_${commentId}`;
    const isRecommended = document.cookie.split('; ').some((item) => item.trim().startsWith(cookieName + '=true'));

    if (isRecommended) {
      alert('ì´ë¯¸ ì¶”ì²œí•˜ì…¨ìŠµë‹ˆë‹¤.');
      return;
    }

    // AJAX ìš”ì²­
    $.ajax({
      url: `/comment/recommend/${commentId}`,
      method: 'POST',
      success: function() {
        alert('ëŒ“ê¸€ì´ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ì¿ í‚¤ ì„¤ì • (ë§Œë£Œ ì‹œê°„ 1ì‹œê°„)
        document.cookie = `${cookieName}=true; path=/; max-age=3600;`;

        // í™”ë©´ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì¶”ì²œ ìˆ˜ ì—…ë°ì´íŠ¸
        const recommendCountSpan = $(button).find('span');
        const currentCount = parseInt(recommendCountSpan.text()) || 0;
        recommendCountSpan.text(currentCount + 1);
      },
      error: function() {
        alert('ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  // ëŒ“ê¸€ ìˆ˜ì • í•¨ìˆ˜
  function editComment(button) {
    // ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ë™ì‘
    const listItem = $(button).closest('.list-group-item');
    const commentText = listItem.find('.comment-text').text(); // í˜„ì¬ ëŒ“ê¸€ ë‚´ìš©ì„ ê°€ì ¸ì˜´
    listItem.find('.edit-comment').val(commentText); // textareaì— í˜„ì¬ ëŒ“ê¸€ ë‚´ìš©ì„ ì„¤ì •
    listItem.find('.comment-text').hide();
    listItem.find('.edit-comment').show();
    $(button).hide(); // ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    listItem.find('.btn-outline-primary').show(); // ì €ì¥ ë²„íŠ¼ ë³´ì´ê¸°
    listItem.find('.btn-outline-secondary').show(); // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ê¸°
  }
  function saveComment(button) {
    // ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ë™ì‘
    const listItem = $(button).closest('.list-group-item');
    const commentId = listItem.find('.comment-id').val();
    const updatedContent = listItem.find('.edit-comment').val();

    $.ajax({
      url: `/comment/edit/${commentId}`,
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ content: updatedContent }),
      success: function() {
        alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        listItem.find('.comment-text').text(updatedContent).show();
        listItem.find('.edit-comment').hide();
        listItem.find('.btn-outline-primary').hide(); // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        listItem.find('.btn-outline-secondary').hide(); // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        listItem.find('.btn-outline-warning').show(); // ìˆ˜ì • ë²„íŠ¼ ë³´ì´ê¸°
      },
      error: function() {
        alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  function cancelEdit(button) {
    // ì·¨ì†Œ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ë™ì‘
    const listItem = $(button).closest('.list-group-item');
    listItem.find('.edit-comment').hide();
    listItem.find('.comment-text').show();
    $(button).hide(); // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    listItem.find('.btn-outline-primary').hide(); // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    listItem.find('.btn-outline-warning').show(); // ìˆ˜ì • ë²„íŠ¼ ë³´ì´ê¸°
  }

  // ëŒ“ê¸€ ì‚­ì œ í•¨ìˆ˜
  function deleteComment(button) {
    const commentId = $(button).closest('.list-group-item').find('.comment-id').val(); // commentId ê°€ì ¸ì˜¤ê¸°
    if (confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      $.ajax({
        url: `/comment/delete/${commentId}`,
        method: 'POST',
        success: function() {
          alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        },
        error: function() {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }
  }

</script>
</body>
</html>
