<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 목록</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .post-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .post-category {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .post-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .post-title a {
            color: #007bff;
            text-decoration: none;
        }
        .post-title a:hover {
            text-decoration: underline;
        }
        .post-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .category-list {
            margin-bottom: 20px;
        }
        .category-item {
            cursor: pointer;
            color: #007bff;
            margin-right: 15px;
        }
        .category-item:hover {
            text-decoration: underline;
        }
        .btn-write {
            margin-top: 20px;
        }
    </style>
    <!-- Favicon -->
    <link th:href="@{/img/favicon.ico}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>

<!-- 헤더를 포함 -->
<div th:replace="includes/header :: headerFragment"></div>
<div class="container">
    <h1 class="mt-4">북고 게시판</h1>

    <!-- 글쓰기 버튼 (로그인 상태에서만 보이게 할 것) -->
    <div class="btn-write" th:if="${username != null}">
        <a href="/board/write" class="btn btn-primary">글쓰기</a>
    </div>

    <!-- 카테고리 목록 -->
    <div id="categories" class="mt-3">
        <button class="btn btn-secondary category-btn" data-category="all">모두</button>
        <!-- 카테고리 버튼들이 추가될 위치 -->
    </div>

    <!-- 게시글 목록 -->
    <div id="posts" class="mt-4">
        <!-- 게시글 목록은 JavaScript를 통해 동적으로 생성 -->
    </div>

    <!-- 검색 및 필터링 -->
    <div class="row mt-4">
        <div class="col-md-12">
            <form id="searchForm">
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label for="searchType">검색 타입</label>
                        <select id="searchType" class="form-control" name="type">
                            <option value="title">제목</option>
                            <option value="username">작성자</option>
                            <option value="content">내용</option>
                        </select>
                    </div>
                    <div class="form-group col-md-9">
                        <label for="searchContent">검색 내용</label>
                        <input type="text" id="searchContent" class="form-control" name="content" placeholder="검색 내용을 입력하세요">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">검색</button>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // 서버에서 게시글 목록 로드
        loadPosts();

        // 카테고리 목록 로드
        loadCategories();

        // 검색 폼 제출 이벤트 핸들러
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            searchPosts();
        });

        // "모두" 버튼과 카테고리 버튼 클릭 이벤트 핸들러
        $('#categories').on('click', '.category-btn', function() {
            const category = $(this).data('category');
            if (category === 'all') {
                loadPosts(); // "모두" 버튼 클릭 시 전체 게시글 로드
            } else {
                loadPostsByCategory(category); // 선택된 카테고리별 게시글 로드
            }
        });

        // 게시글 목록을 로드하는 함수
        function loadPosts() {
            $.ajax({
                url: '/board/load',
                method: 'GET',
                success: function(data) {
                    renderPosts(data);
                },
                error: function() {
                    $('#posts').html('<p>게시글을 로드하는 데 오류가 발생했습니다.</p>');
                }
            });
        }

        // 카테고리별 게시글 목록을 로드하는 함수
        function loadPostsByCategory(categoryId) {
            $.ajax({
                url: `/board/category/${categoryId}`,
                method: 'GET',
                success: function(data) {
                    renderPosts(data);
                },
                error: function() {
                    $('#posts').html('<p>카테고리별 게시글을 로드하는 데 오류가 발생했습니다.</p>');
                }
            });
        }

        // 카테고리 목록을 로드하는 함수
        function loadCategories() {
            $.ajax({
                url: '/board/categories',
                method: 'GET',
                success: function(data) {
                    // 카테고리 버튼들을 동적으로 생성
                    data.forEach(category => {
                        $('#categories').append(`
                        <button class="btn btn-secondary category-btn" data-category="${category.categoryId}">
                            ${category.categoryName}
                        </button>
                    `);
                    });
                },
                error: function() {
                    console.error('카테고리 목록을 로드하는 데 오류가 발생했습니다.');
                }
            });
        }

        // 게시글을 화면에 렌더링하는 함수
        function renderPosts(posts) {
            $('#posts').empty();
            if (posts.length > 0) {
                posts.forEach(post => {
                    $('#posts').append(`
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="post-header">
                                <div class="post-category">
                                    <strong>${post.categoryName || '카테고리 없음'}</strong>
                                </div>
                                <div class="post-title">
                                    <h5 class="card-title">
                                        <a href="/board/detail?postId=${post.postId || ''}">${post.title || '제목 없음'}</a>
                                    </h5>
                                    <div class="post-info">
                                        <span>${post.username || '작성자 없음'}</span>
                                        <span class="ml-3">조회수: ${post.viewCount !== undefined ? post.viewCount : 0}</span>
                                        <span class="ml-3">추천수: ${post.recommendCount !== undefined ? post.recommendCount : 0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                });
            } else {
                $('#posts').html('<p>검색 결과가 없습니다.</p>');
            }
        }

        // 검색 폼을 제출할 때 호출되는 함수
        function searchPosts() {
            const searchType = $('#searchType').val();
            const searchContent = $('#searchContent').val();
            $.ajax({
                url: '/board/search',
                method: 'GET',
                data: { type: searchType, content: searchContent },
                success: function(data) {
                    renderPosts(data);
                },
                error: function() {
                    $('#posts').html('<p>검색 결과를 로드하는 데 오류가 발생했습니다.</p>');
                }
            });
        }
    });
</script>
<div th:replace="includes/footer :: footerFragment"></div>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>

<!-- Contact Javascript File -->
<script th:src="@{/mail/jqBootstrapValidation.min.js}"></script>
<script th:src="@{/mail/contact.js}"></script>

<!-- Template Javascript -->
<script th:src="@{/js/main.js}"></script>
</body>
</html>
